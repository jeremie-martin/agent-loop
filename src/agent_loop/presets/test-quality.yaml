name: test-quality
description: Test suite improvement with self-orchestrated verification

prompt_prefix: |
  FIRST: Find and read all markdown documentation in this project before doing anything else.
  Search for and read: README files (root and subdirectories), CLAUDE.md, AGENTS.md, and all
  files in docs/ or documentation/ directories. Understand the codebase's patterns, conventions,
  and architecture. Only then proceed with your task.

  IMPORTANT - When spawning sub-agents:
  Sub-agents do not automatically have the context you have. For each sub-agent you spawn:
  1. Give it the exact file paths to relevant documentation (CLAUDE.md, README, etc.)
  2. Explicitly instruct it to read those files completely before starting its task
  3. Include any other specific files it needs to examine

  Do not assume sub-agents will find documentation on their own — give them the paths.

prompt_suffix: |
  Do not use the "question" tool or any tool requiring user input.
  Stage and commit your changes at the end with a descriptive message.

  CRITICAL: If a test that was passing before your changes now fails, you
  introduced a regression. Fix your changes—do not change the test's assertions.

modes:
  - name: quality
    prompt: |
      Good tests read as specifications. They communicate what the code should do,
      not just that it runs. A reader understands the tested behavior from the test
      alone, without studying implementation details.

      Quality tests are:
      - Clear about what behavior they verify
      - Independent—running in any order produces the same result
      - Focused on outcomes, not implementation details

      Refactor tests that are unclear or coupled. Delete tests that are redundant
      or verify nothing meaningful. Leave alone tests that already communicate well.

      Focus on the tests that would benefit most from improvement. A few clear
      refactors are better than touching everything.

      **After completing your changes**, orchestrate verification:

      1. Spawn a sub-agent to review your work. Give it:
         - The paths to relevant documentation files and instruct it to read them first
         - The test files you modified
         - Instruction to check: do the refactored tests still verify the same
           behavior? Are any regressions introduced? Any further simplification?

      2. Spawn a filter sub-agent. Give it the verification feedback and ask:
         which concerns are genuine vs over-cautious?

      3. Address filtered feedback, then commit.

  - name: consolidation
    prompt: |
      A focused test suite is easier to maintain and faster to run. Without
      counter-pressure, test suites grow—overlapping tests, tests for code that
      no longer exists, overly granular tests that could be combined.

      Fewer, better tests. Deleting a redundant test is as valuable as adding
      a missing one. Focus on consolidations that meaningfully improve the suite.

      **After completing your changes**, orchestrate verification:

      Spawn a sub-agent to review your work. Give it:
      - The paths to relevant documentation files and instruct it to read them first
      - The test files you modified
      - Instruction to check: did consolidation preserve test coverage?
        Are any behaviors now untested? Any further consolidation possible?

      Address the feedback, then commit.
