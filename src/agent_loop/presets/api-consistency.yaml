name: api-consistency
description: Make API endpoints predictable with uniform naming, responses, and validation

prompt_prefix: |
  Focus on consistency within this API. The goal is predictability—once someone
  knows one endpoint, they can guess how others work.

prompt_suffix: |
  Do not commit changes - they will be reviewed and committed at the end of the cycle.
  Do not use the "question" tool or any tool requiring user input.

modes:
  - name: naming
    prompt: |
      Consistent naming makes APIs predictable. When `/users` and `/posts` follow the same conventions, developers know what to expect from `/comments`.

      Review API endpoint definitions:
      - Do resources use plural nouns? (`/users`, not `/user`)
      - Are HTTP verbs used correctly? (GET reads, POST creates, PUT/PATCH updates, DELETE removes)
      - Is nesting consistent? (`/users/{id}/posts` vs `/posts?user_id=...`)
      - Do similar operations have similar URL patterns?

      Where naming is inconsistent, align it with the dominant pattern in the API. Prefer changes that affect fewer endpoints.

      Note any breaking changes that would require client updates—these may need versioning.

  - name: responses
    prompt: |
      Consistent response shapes reduce surprises. When every endpoint returns data the same way, clients can handle responses generically.

      Review API responses:
      - Do success responses follow the same structure? (data wrapper, metadata location)
      - Are error responses uniform? (same fields, same HTTP status code meanings)
      - Is pagination handled consistently? (same query params, same response shape)
      - Are empty results handled the same way? (empty array vs null vs omitted)

      Standardize response shapes. Pick the pattern used most often and apply it everywhere. Update response schemas/types to match.

  - name: validation
    prompt: |
      Consistent validation makes APIs trustworthy. When validation rules are predictable, developers can build correct clients without trial and error.

      Review input validation:
      - Are required fields enforced consistently?
      - Do similar fields have similar validation? (email fields, dates, IDs)
      - Are validation errors structured the same way? (which field, what's wrong)
      - Is validation documented? (OpenAPI schemas, type hints)

      Standardize validation patterns. Same rules for same field types. Same error shapes for validation failures. Update schemas to document constraints.

  - name: propagation
    prompt: |
      API changes must propagate throughout the codebase. When the API changes, callers, documentation, and tests need to reflect those changes.

      Check git diff to see what API changes were made. For each change, three areas need updating:

      1. **Internal callers**: Code that calls the changed endpoints needs to use the new patterns. Update request shapes, handle new response formats, adapt to validation changes.

      2. **Documentation**: API references, examples, and parameter descriptions need to match reality. README files, API docs, inline comments that mention endpoints.

      3. **Tests**: Test expectations need to match the new behavior. Mock responses, test data, assertion values.

      Work through each area. These three concerns are independent—parallelize across them when the codebase is large.

      After all updates, run the full test suite. Breaking changes are acceptable when the entire codebase adapts accordingly. The measure of success is passing tests.

review:
  enabled: true
  scope_globs:
    - "**/routes/**"
    - "**/api/**"
    - "**/endpoints/**"
    - "**/controllers/**"
    - "**/views/**"
    - "**/*schema*.py"
    - "**/*schema*.ts"
  check_prompt: |
    Review only the API-related changes (routes, controllers, schemas).
    Ignore unrelated files.

    For each modification, verify:
    1. Changes don't break existing API contracts unintentionally
    2. Response shapes are valid (correct JSON structure, types)
    3. Validation logic is correct (no false rejections or acceptances)

    If API tests exist, run them to confirm endpoints still work.

  filter_prompt: |
    Filter out:
    - Suggestions for new endpoints or features
    - Opinions about REST vs GraphQL or other paradigms
    - Requests to change authentication/authorization
    - Concerns about non-API code

    Only act on API breakages or validation errors.
